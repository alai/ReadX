<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article 提取方案测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #1da1f2;
            border-bottom: 2px solid #1da1f2;
            padding-bottom: 10px;
        }
        .selector-test {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-left: 3px solid #28a745;
        }
        .selector-test.fail {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .code {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
        }
        .success { color: #28a745; font-weight: bold; }
        .fail { color: #dc3545; font-weight: bold; }
        .info { color: #007bff; }
    </style>
</head>
<body>
    <h1>📝 X.com Article 页面内容提取方案测试</h1>
    
    <div class="test-section">
        <h2>🎯 测试目标</h2>
        <p>验证从 X.com 官方 Article 页面提取长文内容的可行性</p>
        <ul>
            <li>✅ 识别 Article 容器</li>
            <li>✅ 提取文章标题</li>
            <li>✅ 提取文章正文（Draft.js 格式）</li>
            <li>✅ 处理不同的内容块（段落、标题、列表、图片等）</li>
            <li>✅ 保持内容结构和格式</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>🔍 关键选择器识别</h2>
        
        <div class="selector-test" id="test-article-container">
            <strong>1. Article 容器识别</strong>
            <div class="code">
// 方法1: 通过 data-testid
const articleContainer = document.querySelector('[data-testid="twitterArticleRichTextView"]');

// 方法2: 通过 DraftEditor 类
const draftEditor = document.querySelector('.DraftEditor-root');
            </div>
            <div class="result" id="result-article-container"></div>
        </div>

        <div class="selector-test" id="test-article-title">
            <strong>2. 文章标题提取</strong>
            <div class="code">
// 标题选择器
const title = document.querySelector('[data-testid="twitter-article-title"]');
// 或者
const titleAlt = document.querySelector('.longform-header-two, h2[class*="longform"]');
            </div>
            <div class="result" id="result-article-title"></div>
        </div>

        <div class="selector-test" id="test-article-content">
            <strong>3. 文章内容块提取</strong>
            <div class="code">
// Draft.js 内容容器
const contentBlocks = document.querySelectorAll('[data-block="true"]');

// 不同类型的内容块
// - 段落: .longform-unstyled
// - 标题: .longform-header-two
// - 引用: .longform-blockquote
// - 列表: .longform-unordered-list-item, .longform-ordered-list-item
// - 图片: section[data-block="true"] img
            </div>
            <div class="result" id="result-article-content"></div>
        </div>

        <div class="selector-test" id="test-text-extraction">
            <strong>4. 文本提取方法</strong>
            <div class="code">
// 方法1: 通过 data-text="true" 的 span
const textSpans = block.querySelectorAll('span[data-text="true"]');
const text = Array.from(textSpans).map(span => span.textContent).join('');

// 方法2: 直接使用 textContent (可能包含额外空格)
const text = block.textContent.trim();
            </div>
            <div class="result" id="result-text-extraction"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>📋 提取策略分析</h2>
        <div style="line-height: 1.8;">
            <h3>DOM 结构特征：</h3>
            <ul>
                <li><strong>容器标识：</strong> <code>data-testid="twitterArticleRichTextView"</code></li>
                <li><strong>编辑器框架：</strong> Draft.js (<code>.DraftEditor-root</code>)</li>
                <li><strong>内容块：</strong> 每个段落/标题都是独立的 <code>data-block="true"</code> 元素</li>
                <li><strong>文本标记：</strong> 实际文本内容在 <code>span[data-text="true"]</code> 中</li>
            </ul>

            <h3>提取策略：</h3>
            <ol>
                <li><strong>检测 Article 页面：</strong>
                    <ul>
                        <li>查找 <code>[data-testid="twitterArticleRichTextView"]</code></li>
                        <li>确认存在 Draft.js 结构</li>
                    </ul>
                </li>
                <li><strong>提取标题：</strong>
                    <ul>
                        <li>优先使用 <code>[data-testid="twitter-article-title"]</code></li>
                        <li>备用：第一个 <code>.longform-header-two</code></li>
                    </ul>
                </li>
                <li><strong>提取正文：</strong>
                    <ul>
                        <li>遍历所有 <code>[data-block="true"]</code></li>
                        <li>根据 class 判断块类型（段落、标题、引用、列表）</li>
                        <li>提取 <code>span[data-text="true"]</code> 的文本</li>
                        <li>保持块的层级关系和格式</li>
                    </ul>
                </li>
                <li><strong>处理图片：</strong>
                    <ul>
                        <li>查找 <code>section[data-block="true"]</code> 中的图片</li>
                        <li>提取图片 URL 和 alt 文本</li>
                    </ul>
                </li>
            </ol>

            <h3>与现有推文提取的对比：</h3>
            <table style="width:100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="border: 1px solid #dee2e6; padding: 8px;">特性</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px;">普通推文</th>
                        <th style="border: 1px solid #dee2e6; padding: 8px;">Article 页面</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border: 1px solid #dee2e6; padding: 8px;">容器选择器</td>
                        <td style="border: 1px solid #dee2e6; padding: 8px;"><code>[data-testid="tweetText"]</code></td>
                        <td style="border: 1px solid #dee2e6; padding: 8px;"><code>[data-testid="twitterArticleRichTextView"]</code></td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #dee2e6; padding: 8px;">内容结构</td>
                        <td style="border: 1px solid #dee2e6; padding: 8px;">单一段落，可能有链接</td>
                        <td style="border: 1px solid #dee2e6; padding: 8px;">多层级：标题、段落、引用、列表</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #dee2e6; padding: 8px;">文本提取</td>
                        <td style="border: 1px solid #dee2e6; padding: 8px;">直接 textContent 或 innerHTML</td>
                        <td style="border: 1px solid #dee2e6; padding: 8px;">遍历 data-block，提取 data-text span</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #dee2e6; padding: 8px;">格式保持</td>
                        <td style="border: 1px solid #dee2e6; padding: 8px;">简单，主要是换行</td>
                        <td style="border: 1px solid #dee2e6; padding: 8px;">复杂，需保持块类型和层级</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="test-section">
        <h2>⚠️ 注意事项</h2>
        <ul>
            <li>Article 页面使用 Draft.js 编辑器框架，DOM 结构比普通推文复杂</li>
            <li>需要处理多种内容块类型（段落、标题、引用、列表等）</li>
            <li>文本内容在 <code>span[data-text="true"]</code> 中，可能有多个 span 组成一段</li>
            <li>图片嵌入在 <code>section[data-block="true"]</code> 中，需单独处理</li>
            <li>可能包含内嵌的推文（需要额外处理）</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>✅ 实施建议</h2>
        <ol>
            <li><strong>检测优先级：</strong>
                <ul>
                    <li>先检查是否为 Article 页面（存在 <code>twitterArticleRichTextView</code>）</li>
                    <li>如果是，使用 Article 专用提取器</li>
                    <li>否则，使用现有的推文提取器</li>
                </ul>
            </li>
            <li><strong>提取器实现：</strong>
                <ul>
                    <li>创建 <code>ArticleExtractor</code> 类</li>
                    <li>实现 <code>extractTitle()</code> 方法</li>
                    <li>实现 <code>extractContent()</code> 方法，遍历所有 data-block</li>
                    <li>实现 <code>extractImages()</code> 方法</li>
                </ul>
            </li>
            <li><strong>内容重组：</strong>
                <ul>
                    <li>将提取的块按原始顺序组合</li>
                    <li>保持段落、标题、引用的格式</li>
                    <li>正确处理列表的嵌套</li>
                    <li>图片插入到适当位置</li>
                </ul>
            </li>
        </ol>
    </div>

    <div class="test-section">
        <h2>🚀 下一步</h2>
        <ol>
            <li>在 <code>content.js</code> 中添加 Article 检测逻辑</li>
            <li>实现 <code>ArticleExtractor</code> 类</li>
            <li>修改 <code>ReadingModeManager</code>，支持 Article 内容</li>
            <li>调整 CSS 样式，适配 Article 的多层级结构</li>
            <li>测试不同长度和复杂度的 Article 页面</li>
        </ol>
    </div>

    <script>
        // 这个脚本会在实际的 X.com Article 页面中运行测试
        function runTests() {
            const results = {
                articleContainer: false,
                articleTitle: false,
                articleContent: false,
                textExtraction: false
            };

            // 测试 1: Article 容器识别
            const articleContainer = document.querySelector('[data-testid="twitterArticleRichTextView"]');
            const draftEditor = document.querySelector('.DraftEditor-root');
            results.articleContainer = !!(articleContainer && draftEditor);
            updateResult('result-article-container', results.articleContainer, 
                articleContainer ? `✅ 找到 Article 容器，包含 ${draftEditor.querySelectorAll('[data-block="true"]').length} 个内容块` : 
                '❌ 未找到 Article 容器');

            // 测试 2: 文章标题提取
            const title = document.querySelector('[data-testid="twitter-article-title"]');
            results.articleTitle = !!title;
            updateResult('result-article-title', results.articleTitle,
                title ? `✅ 标题: "${title.textContent.trim().substring(0, 50)}..."` : 
                '❌ 未找到标题');

            // 测试 3: 文章内容块提取
            const contentBlocks = document.querySelectorAll('[data-block="true"]');
            results.articleContent = contentBlocks.length > 0;
            if (contentBlocks.length > 0) {
                const blockTypes = {};
                contentBlocks.forEach(block => {
                    const classList = Array.from(block.classList);
                    const type = classList.find(c => c.startsWith('longform-')) || 'unknown';
                    blockTypes[type] = (blockTypes[type] || 0) + 1;
                });
                const typesSummary = Object.entries(blockTypes)
                    .map(([type, count]) => `${type}: ${count}`)
                    .join(', ');
                updateResult('result-article-content', results.articleContent,
                    `✅ 找到 ${contentBlocks.length} 个内容块 (${typesSummary})`);
            } else {
                updateResult('result-article-content', results.articleContent,
                    '❌ 未找到内容块');
            }

            // 测试 4: 文本提取
            if (contentBlocks.length > 0) {
                const firstBlock = contentBlocks[0];
                const textSpans = firstBlock.querySelectorAll('span[data-text="true"]');
                const text = Array.from(textSpans).map(span => span.textContent).join('');
                results.textExtraction = text.length > 0;
                updateResult('result-text-extraction', results.textExtraction,
                    text ? `✅ 成功提取文本: "${text.substring(0, 100)}..."` : 
                    '❌ 文本提取失败');
            } else {
                updateResult('result-text-extraction', false, '⏭️ 跳过（无内容块）');
            }

            // 总结
            const passCount = Object.values(results).filter(v => v).length;
            const totalCount = Object.keys(results).length;
            console.log(`测试完成: ${passCount}/${totalCount} 通过`, results);
        }

        function updateResult(elementId, success, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<span class="${success ? 'success' : 'fail'}">${message}</span>`;
                const testSection = element.closest('.selector-test');
                if (testSection && !success) {
                    testSection.classList.add('fail');
                }
            }
        }

        // 当页面加载完成后运行测试
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runTests);
        } else {
            runTests();
        }

        // 提供手动运行测试的按钮
        const manualTestButton = document.createElement('button');
        manualTestButton.textContent = '🔄 重新运行测试';
        manualTestButton.style.cssText = 'position: fixed; bottom: 20px; right: 20px; padding: 15px 30px; background: #1da1f2; color: white; border: none; border-radius: 25px; cursor: pointer; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 9999;';
        manualTestButton.onclick = runTests;
        document.body.appendChild(manualTestButton);
    </script>
</body>
</html>
